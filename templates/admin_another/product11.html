{% extends 'admin_another/adminbase.html' %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Product List</h3>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#productModal" id="openAddModal">
            <i class="bi bi-plus-circle"></i> Add Product
        </button>
    </div>

    <!-- DataTable -->
    <table id="productTable" class="table table-bordered table-hover table-responsive table-striped">
        <thead class="table-light">
            <tr>
                <th style="width: 40%;">Product Detail</th>
                <th>Cover Image</th>
                <th>Variants</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic rows inserted via JS -->
        </tbody>
    </table>
</div>

<!-- Add/Edit product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title text-white" id="modalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" id="product_id">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Name</label>
                        <input type="text" name="name" id="id_name" class="form-control" placeholder="Enter product name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Subcategory</label>
                        <select name="sub_category" id="id_subcategory" class="form-select" required>
                            <option value="">Select Subcategory</option>
                            {% for sub in subcategories %}
                                <option value="{{ sub.id }}">{{ sub.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Price</label>
                            <input type="number" name="price" id="id_price" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Discount (%)</label>
                            <input type="number" name="discount" id="id_discount" class="form-control" value="0" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Final Price</label>
                            <input type="number" name="afterdiscountprice" id="id_afterdiscountprice" class="form-control bg-light" readonly>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label fw-bold">Description 1</label>
                        <textarea name="description1" id="id_description1" rows="2" class="form-control" required></textarea>
                    </div>

                    <div class="mt-3">
                        <label class="form-label fw-bold">Description 2</label>
                        <textarea name="description2" id="id_description2" rows="2" class="form-control" required></textarea>
                    </div>

                    <div class="form-check mt-2">
                        <input type="checkbox" class="form-check-input" name="trending" id="trending">
                        <label class="form-check-label" for="trending">Trending</label>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="newArriable" id="new_arrival">
                        <label class="form-check-label" for="new_arrival">New Arrival</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cover Photo</label>
                        <input type="file" name="coverphoto" class="form-control" id="coverPhotoInput" accept="image/*">
                        <img id="coverPhotoPreview" src="" class="img-thumbnail mt-2" style="max-width:150px;display:none;">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Product Variant Images</label>
                        <div id="productImages"></div>
                        <button type="button" id="addImage" class="btn btn-dark mt-2">+ Add Product Image</button>
                    </div>

                    <button type="submit" class="btn btn-success">Save Product</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block contentscript %}
<script>
$(document).ready(function () {
    const baseUrl = "http://127.0.0.1:8000/";

    // --- Utility functions ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function calculateDiscountedPrice() {
        let price = parseFloat($("#id_price").val()) || 0;
        let discount = parseFloat($("#id_discount").val()) || 0;
        $("#id_afterdiscountprice").val(Math.round(price - (price * discount / 100)));
    }
    $("#id_price, #id_discount").on("input", calculateDiscountedPrice);

    // --- Cover photo preview ---
    $("#coverPhotoInput").on("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                $("#coverPhotoPreview").attr("src", e.target.result).show();
            }
            reader.readAsDataURL(file);
        }
    });

    // --- Variant images ---
    $("#addImage").click(function () {
        const newRow = `
            <div class="row g-2 mb-2 image-row">
                <div class="col-md-4">
                    <input type="text" name="image_name[]" class="form-control" placeholder="Variant Name" required>
                </div>
                <div class="col-md-4">
                    <input type="file" name="image_file[]" class="form-control image-input" accept="image/*" required>
                </div>
                <div class="col-md-2 d-flex align-items-center preview-container">
                    <span class="text-muted">No Image</span>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger remove-row">&times;</button>
                </div>
            </div>`;
        $("#productImages").append(newRow);
    });

    $(document).on("change", ".image-input", function () {
        const file = this.files[0];
        const previewContainer = $(this).closest(".image-row").find(".preview-container");
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewContainer.html(`<img src="${e.target.result}" class="img-thumbnail" style="width:80px; height:80px;">`);
            }
            reader.readAsDataURL(file);
        } else {
            previewContainer.html(`<span class="text-muted">No Image</span>`);
        }
    });

    $(document).on("click", ".remove-row", function () {
        $(this).closest(".image-row").remove();
    });

    // --- Load all products into table ---
    function loadProducts() {
        $.ajax({
            url: '/products/',
            type: 'GET',
            success: function(data){
                const tbody = $("#productTable tbody");
                tbody.empty();
                data.forEach(function(product){
                    let coverImg = product.coverphoto ? `<img src="${product.coverphoto.startsWith('http') ? product.coverphoto : baseUrl+product.coverphoto}" width="80">` : 'No Image';
                    let variantImgs = product.productimages.length ? product.productimages.map(v=>`<img src="${v.image.startsWith('http') ? v.image : baseUrl+v.image}" width="50" class="me-1">`).join('') : 'No Variant';
                    let row = `
                        <tr>
                            <td>
                                <strong>${product.name}</strong><br>
                                <small>Subcategory: ${product.sub_category.name}</small><br>
                                <small>Price: ${product.price}, Discount: ${product.discount}%, Final: ${product.afterdiscountprice}</small>
                            </td>
                            <td>${coverImg}</td>
                            <td>${variantImgs}</td>
                            <td>
                                <button class="btn btn-sm btn-warning editBtn" data-id="${product.id}">Edit</button>
                                <button class="btn btn-sm btn-danger deleteBtn" data-id="${product.id}">Delete</button>
                            </td>
                        </tr>`;
                    tbody.append(row);
                });
            },
            error: function(xhr){
                console.error("Failed to load products", xhr.responseText);
            }
        });
    }

    loadProducts();

    // --- Edit product ---
    $(document).on("click", ".editBtn", function () {
        let productId = $(this).data("id");
        $.ajax({
            url: `/products/${productId}/`,
            type: "GET",
            success: function(data){
                $("#product_id").val(data.id);
                $("#id_name").val(data.name);
                $("#id_subcategory").val(data.sub_category.id).trigger("change");
                $("#id_price").val(data.price);
                $("#id_discount").val(data.discount);
                $("#id_afterdiscountprice").val(data.afterdiscountprice);
                $("#id_description1").val(data.description1);
                $("#id_description2").val(data.description2);
                $("#trending").prop("checked", data.trending);
                $("#new_arrival").prop("checked", data.newArriable || data.new_arrival);

                if(data.coverphoto){
                    const coverUrl = data.coverphoto.startsWith("http") ? data.coverphoto : baseUrl + data.coverphoto;
                    $("#coverPhotoPreview").attr("src", coverUrl).show();
                } else {
                    $("#coverPhotoPreview").hide().attr("src", "");
                }

                $("#productImages").empty();
                data.productimages.forEach(function(v){
                    const row = `
                        <div class="row g-2 mb-2 image-row">
                            <input type="hidden" name="image_id[]" value="${v.id}">
                            <input type="hidden" name="existing_image_url[]" value="${v.image || ''}">
                            <div class="col-md-4">
                                <input type="text" name="image_name[]" class="form-control" value="${v.name}" placeholder="Variant Name" required>
                            </div>
                            <div class="col-md-4">
                                <input type="file" name="image_file[]" class="form-control image-input" accept="image/*">
                            </div>
                            <div class="col-md-2 d-flex align-items-center preview-container">
                                ${v.image ? `<img src="${v.image.startsWith("http") ? v.image : baseUrl+v.image}" class="img-thumbnail" width="80">` : `<span class="text-muted">No Image</span>`}
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger remove-row">&times;</button>
                            </div>
                        </div>`;
                    $("#productImages").append(row);
                });

                $("#modalTitle").text("Edit Product");
                $("#productModal").modal("show");
            }
        });
    });

    // --- Submit form (Add/Update) ---
    $("#productForm").submit(function(e){
        e.preventDefault();
        let id = $("#product_id").val();
        let url = id ? `/products/${id}/` : `/products/`;
        let formData = new FormData(this);
        if(id) formData.append("_method","PUT");

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: {"X-CSRFToken": getCookie("csrftoken")},
            success: function(res){
                $("#productModal").modal("hide");
                loadProducts();
            },
            error: function(xhr){
                console.error(xhr.responseText);
            }
        });
    });

    // --- Delete product ---
    $(document).on("click",".deleteBtn", function(){
        let id = $(this).data("id");
        if(confirm("Are you sure you want to delete this product?")){
            $.ajax({
                url:`/products/${id}/`,
                type:"DELETE",
                headers:{"X-CSRFToken": getCookie("csrftoken")},
                success:function(){
                    loadProducts();
                }
            });
        }
    });

});
</script>
{% endblock %}
