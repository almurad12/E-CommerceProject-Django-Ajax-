{% extends 'admin_another/adminbase.html' %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">Categories</h2>

    <!-- Add Category Button -->
    <button class="btn btn-dark mb-3" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
        <i class="bi bi-plus-lg me-1"></i> Add Category
    </button>

    <!-- Category Table -->
    <div class="table-responsive">
        <table id="categoryTable" class="table table-bordered align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Categories injected by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addCategoryForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" id="categoryName" required>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Category</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Update Category Modal -->
<div class="modal fade" id="updateCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="updateCategoryForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="updateCategoryId">
            <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" id="updateCategoryName" required>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Update Category</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete Category Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="deleteCategoryForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            Are you sure you want to delete this category?
            <input type="hidden" id="deleteCategoryId">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block contentscript %}
<!-- <script>
    $(document).ready(function() {

    // Dummy category data
    let categories = [
        {id: 1, name: 'Electronics'},
        {id: 2, name: 'Clothing'},
        {id: 3, name: 'Books'}
    ];

    let categoryTable = $('#categoryTable').DataTable({
        responsive: true,
        autoWidth: false
    });

    // Function to render table
    function renderTable() {
        categoryTable.clear();
        categories.forEach(cat => {
            categoryTable.row.add([
                cat.id,
                cat.name,
                `<button class="btn btn-sm btn-success me-1" onclick="editCategory(${cat.id})">Edit</button>
                 <button class="btn btn-sm btn-danger" onclick="confirmDeleteCategory(${cat.id})">Delete</button>`
            ]);
        });
        categoryTable.draw();
    }

    renderTable();

    // Add Category
    $('#addCategoryForm').submit(function(e) {
        e.preventDefault();
        let name = $('#categoryName').val();
        let newId = categories.length ? categories[categories.length-1].id + 1 : 1;
        categories.push({id: newId, name: name});
        $('#addCategoryModal').modal('hide');
        $('#addCategoryForm')[0].reset();
        renderTable();
    });

    // Edit Category
    window.editCategory = function(id) {
        let cat = categories.find(c => c.id === id);
        $('#updateCategoryId').val(cat.id);
        $('#updateCategoryName').val(cat.name);
        $('#updateCategoryModal').modal('show');
    }

    $('#updateCategoryForm').submit(function(e) {
        e.preventDefault();
        let id = parseInt($('#updateCategoryId').val());
        let cat = categories.find(c => c.id === id);
        cat.name = $('#updateCategoryName').val();
        $('#updateCategoryModal').modal('hide');
        renderTable();
    });

    // Delete Category
    window.confirmDeleteCategory = function(id) {
        $('#deleteCategoryId').val(id);
        $('#deleteCategoryModal').modal('show');
    }

    $('#deleteCategoryForm').submit(function(e) {
        e.preventDefault();
        let id = parseInt($('#deleteCategoryId').val());
        categories = categories.filter(c => c.id !== id);
        $('#deleteCategoryModal').modal('hide');
        renderTable();
    });

});
</script> -->
<!-- <script>
$(document).ready(function() {

    // CSRF setup for Django
    $.ajaxSetup({
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });

    // Function to load categories via AJAX
    function loadCategories() {
        $.get('/admincategory/', function(data) {
            let tbody = $('#categoryTable tbody');
            tbody.empty(); // clear existing rows
            data.forEach(cat => {
                tbody.append(`
                    <tr id="row-${cat.id}">
                        <td>${cat.id}</td>
                        <td>${cat.name}</td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="editCategory(${cat.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteCategory(${cat.id})">Delete</button>
                        </td>
                    </tr>
                `);
            });
        });
    }

    loadCategories(); // Initial load

    // Add Category
    $('#addCategoryForm').submit(function(e) {
        e.preventDefault();
        let name = $('#categoryName').val();

        $.ajax({
            url: '/admincategory/',
            method: 'POST',
            data: JSON.stringify({ name: name }),
            contentType: 'application/json',
            success: function(data) {
                $('#addCategoryModal').modal('hide');
                $('#addCategoryForm')[0].reset();
                loadCategories(); // reload table
            },
            error: function(err) {
                alert('Error adding category');
            }
        });
    });

    // Edit Category
    window.editCategory = function(id) {
        $.get(`/admincategory/${id}/`, function(data) {
            $('#updateCategoryId').val(data.id);
            $('#updateCategoryName').val(data.name);
            $('#updateCategoryModal').modal('show');
        });
    }

    $('#updateCategoryForm').submit(function(e) {
        e.preventDefault();
        let id = $('#updateCategoryId').val();
        let name = $('#updateCategoryName').val();

        $.ajax({
            url: `/admincategory/${id}/`,
            method: 'PUT',
            data: JSON.stringify({ name: name }),
            contentType: 'application/json',
            success: function() {
                $('#updateCategoryModal').modal('hide');
                loadCategories(); // reload table
            },
            error: function(err) {
                alert('Error updating category');
            }
        });
    });

    // Delete Category
    window.confirmDeleteCategory = function(id) {
        $('#deleteCategoryId').val(id);
        $('#deleteCategoryModal').modal('show');
    }

    $('#deleteCategoryForm').submit(function(e) {
        e.preventDefault();
        let id = $('#deleteCategoryId').val();

        $.ajax({
            url: `/admincategory/${id}/`,
            method: 'DELETE',
            success: function() {
                $('#deleteCategoryModal').modal('hide');
                $(`#row-${id}`).remove(); // remove row without reloading
            },
            error: function(err) {
                alert('Error deleting category');
            }
        });
    });

});
</script> -->

<script>
$(document).ready(function() {

    // CSRF setup for Django
    $.ajaxSetup({
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });

    // Initialize DataTable with AJAX source
    let categoryTable = $('#categoryTable').DataTable({
        responsive: true,
        autoWidth: false,
        ajax: {
            url: '/admincategory/',   // DRF endpoint
            dataSrc: ''               // because DRF returns a plain array
        },
        columns: [
            { data: 'id' },
            { data: 'name' },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `
                        <button class="btn btn-sm btn-success me-1" onclick="editCategory(${data})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteCategory(${data})">Delete</button>
                    `;
                }
            }
        ]
    });

    // Add Category
    $('#addCategoryForm').submit(function(e) {
        e.preventDefault();
        let name = $('#categoryName').val();

        $.ajax({
            url: '/admincategory/',
            method: 'POST',
            data: JSON.stringify({ name: name }),
            contentType: 'application/json',
            success: function() {
                $('#addCategoryModal').modal('hide');
                $('#addCategoryForm')[0].reset();
                categoryTable.ajax.reload(null, false); // reload without resetting pagination
            },
            error: function() {
                alert('Error adding category');
            }
        });
    });

    // Edit Category
    window.editCategory = function(id) {
        $.get(`/admincategory/${id}/`, function(data) {
            $('#updateCategoryId').val(data.id);
            $('#updateCategoryName').val(data.name);
            $('#updateCategoryModal').modal('show');
        });
    }

    $('#updateCategoryForm').submit(function(e) {
        e.preventDefault();
        let id = $('#updateCategoryId').val();
        let name = $('#updateCategoryName').val();

        $.ajax({
            url: `/admincategory/${id}/`,
            method: 'PUT',
            data: JSON.stringify({ name: name }),
            contentType: 'application/json',
            success: function() {
                $('#updateCategoryModal').modal('hide');
                categoryTable.ajax.reload(null, false);
            },
            error: function() {
                alert('Error updating category');
            }
        });
    });

    // Delete Category
    window.confirmDeleteCategory = function(id) {
        $('#deleteCategoryId').val(id);
        $('#deleteCategoryModal').modal('show');
    }

    $('#deleteCategoryForm').submit(function(e) {
        e.preventDefault();
        let id = $('#deleteCategoryId').val();

        $.ajax({
            url: `/admincategory/${id}/`,
            method: 'DELETE',
            success: function() {
                $('#deleteCategoryModal').modal('hide');
                categoryTable.ajax.reload(null, false);
            },
            error: function() {
                alert('Error deleting category');
            }
        });
    });

});
</script>

{% endblock %}
